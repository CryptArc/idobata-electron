<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Idobata</title>
    <style>
      html, body { height: 100%; }
      body { margin: 0px; }
      webview {
        height: 100%;
        width:  100%;
      }
    </style>
  </head>
  <body>
    <webview id="idobata" src="https://idobata.io/" autosize='on'></webview>
    <script src="http://js.pusher.com/2.2/pusher.min.js" type="text/javascript"></script>
    <script>
      var webview  = document.getElementById('idobata');
      // Prevent to become TOFU on my laptop :)
      var guestCSS = '*{font-family: "VL Gothic"}';

      webview.addEventListener("did-stop-loading", function() {
        webview.insertCSS(guestCSS);
      });

      webview.addEventListener("new-window", function(e) {
        require('shell').openExternal(e.url);
      });

      var code = " (function(){ " +
      "        var onMessageCreated = function(user, store, router) { " +
      "          return function(data){ " +
      "            var notify = false; " +
      "            var mode =  " + "all" +
      "            if (mode == 'all') { " +
      "              notify = true; " +
      "            } else if (mode == 'mention') { " +
      "              if (data.message.mentions.indexOf(parseInt(user.get('id'))) >= 0) { " +
      "                notify = true; " +
      "              } " +
      "            } " +
      "            if (notify) { " +
      "              store.find('message', data.message.id).then(function(message) { " +
      "                var roomUrl = '/' + router.generate('room.index', message.get('room')); " +
      "                var roomName = message.get('room.organization.name').toString() + ' / ' + message.get('room.name').toString(); " +
      "                var payload = { " +
      "                  sender: data.message.senderName, " +
      "                  roomName: roomName, " +
      "                  text: data.message.bodyPlain, " +
      "                  iconUrl: data.message.senderIconUrl, " +
      "                  url: roomUrl " +
      "                }; " +
      "                new Notification(JSON.stringify(payload)); " +
      "              }); " +
      "            } " +
      "          }; " +
      "        }; " +
      " " +
      "        window.addEventListener('ready.idobata', function(e) { " +
      " alert('ready.idobata') " +
      "          var container = e.detail.container; " +
      " " +
      "          var pusher = container.lookup('pusher:main'); " +
      "          var user   = container.lookup('service:session').get('user'); " +
      "          var store  = container.lookup('store:main'); " +
      "          var router = container.lookup('router:main'); " +
      " " +
      "          pusher.bind('message:created', onMessageCreated(user, store, router)); " +
      "        }); " +
      "      })(); ";

      webview.addEventListener("dom-ready", function(){
        alert("test")
        webview.executeJavaScript(code);
      });
      
    </script>
  </body>
</html>
